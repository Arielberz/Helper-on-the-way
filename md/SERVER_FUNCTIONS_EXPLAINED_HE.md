# מדריך פונקציות Server - Helper on the Way

תיעוד מפורט של הפונקציות העיקריות בשרת, מיקומן והסבר לוגי על תפקידן.

---

## תוכן עניינים

1. [בקרת משתמשים (User Controller)](#1-בקרת-משתמשים-user-controller)
2. [בקרת בקשות עזרה (Requests Controller)](#2-בקרת-בקשות-עזרה-requests-controller)
3. [בקרת תשלומים (Payment Controller)](#3-בקרת-תשלומים-payment-controller)
4. [בקרת צ'אט (Chat Controller)](#4-בקרת-צאט-chat-controller)
5. [בקרת דירוגים (Rating Controller)](#5-בקרת-דירוגים-rating-controller)
6. [בקרת מנהל מערכת (Admin Controller)](#6-בקרת-מנהל-מערכת-admin-controller)
7. [אימות וזיהוי (Authentication Middleware)](#7-אימות-וזיהוי-authentication-middleware)
8. [שירות צ'אט (Chat Service)](#8-שירות-צאט-chat-service)
9. [שירות PayPal](#9-שירות-paypal)
10. [תקשורת בזמן אמת (Chat Sockets)](#10-תקשורת-בזמן-אמת-chat-sockets)
11. [פונקציות עזר (Utilities)](#11-פונקציות-עזר-utilities)

---

## 1. בקרת משתמשים (User Controller)

**מיקום:** `server/api/controllers/userController.js`

### 1.1 `register` - הרשמת משתמש חדש

**שם הפונקציה:** `exports.register`

**הסבר:**
פונקציה זו אחראית על רישום משתמשים חדשים למערכת. היא מבצעת בדיקות תקינות מקיפות על הנתונים שהמשתמש הזין, מצפינה את הסיסמה, ושולחת קוד אימות למייל.

**תהליך לוגי:**
1. **קבלת נתונים:** מקבלת שם משתמש, אימייל, סיסמה, טלפון ואישור לתנאי השימוש
2. **נורמליזציה:** מנרמלת את הנתונים (הופכת לאותיות קטנות, מסירה רווחים, מנרמלת מספרי טלפון ישראליים)
3. **ולידציה:**
   - שם משתמש: 3-30 תווים, רק אותיות, מספרים, נקודה וקו תחתון
   - אימייל: פורמט אימייל תקין
   - טלפון: פורמט ישראלי (+9725XXXXXXXX)
   - סיסמה: לפחות 8 תווים
   - חובה לאשר תנאי שימוש
4. **בדיקת קיום:** בודקת שהאימייל/טלפון לא קיימים במערכת
5. **הצפנה:** מצפינה את הסיסמה באמצעות bcrypt
6. **יצירת קוד אימות:** מייצרת קוד אימות בן 6 ספרות
7. **שמירה:** שומרת את המשתמש במסד הנתונים
8. **שליחת מייל:** שולחת קוד אימות למייל המשתמש
9. **תגובה:** מחזירה הודעת הצלחה (ללא טוקן - המשתמש צריך לאמת מייל תחילה)

**הערות חשובות:**
- אם המייל תואם למייל האדמין (מוגדר ב-ENV), המשתמש מקבל הרשאות מנהל
- המשתמש לא מקבל טוקן JWT עד שהוא מאמת את המייל

---

### 1.2 `login` - התחברות למערכת

**שם הפונקציה:** `exports.login`

**הסבר:**
מאפשרת למשתמשים להתחבר למערכת באמצעות אימייל או טלפון עם סיסמה.

**תהליך לוגי:**
1. **קבלת נתונים:** מקבלת מזהה (אימייל או טלפון) וסיסמה
2. **זיהוי סוג המזהה:** בודקת אם המזהה הוא אימייל או טלפון
3. **חיפוש משתמש:** מחפשת את המשתמש במסד הנתונים
4. **בדיקת חסימה:** בודקת אם החשבון חסום
5. **אימות סיסמה:** משווה את הסיסמה עם הסיסמה המוצפנת
6. **בדיקת אימות מייל:** וודא שהמשתמש אימת את המייל שלו
7. **יצירת טוקן:** מייצרת JWT token עם תוקף של שעה (ברירת מחדל)
8. **תגובה:** מחזירה את הטוקן ופרטי המשתמש

**הערות חשובות:**
- משתמש חסום מקבל הודעת שגיאה מיוחדת עם סיבת החסימה
- משתמש שלא אימת מייל לא יכול להתחבר

---

### 1.3 פונקציות נוספות ב-User Controller

#### `normalizeEmail` - נורמליזציה של אימייל
הופכת אימייל לאותיות קטנות ומסירה רווחים.

#### `normalizePhone` - נורמליזציה של מספר טלפון
ממירה מספרי טלפון ישראליים לפורמט בינלאומי תקני (+9725XXXXXXXX).
- `05X-XXXXXXX` → `+9725XXXXXXXX`
- `9725XXXXXXXX` → `+9725XXXXXXXX`

#### `isValidEmail`, `isValidUsername`, `isValidPhone`
פונקציות וולידציה שבודקות תקינות הנתונים בעזרת ביטויים רגולריים (regex).

#### `sanitizeUser` - ניקוי אובייקט משתמש
מחזירה רק את השדות המותרים לשליחה לצד הלקוח (ללא סיסמה, קודי אימות וכו').

---

## 2. בקרת בקשות עזרה (Requests Controller)

**מיקום:** `server/api/controllers/requestsController.js`

### 2.1 `createRequest` - יצירת בקשת עזרה חדשה

**שם הפונקציה:** `exports.createRequest`

**הסבר:**
מאפשרת למשתמש ליצור בקשת עזרה בכביש (תקלה ברכב, חוסר דלק וכו').

**תהליך לוגי:**
1. **קבלת נתונים:** מיקום (lat/lng), סוג בעיה, תיאור, תמונות (אופציונלי), סכום מוצע (אופציונלי)
2. **ולידציה:**
   - מיקום חייב להיות תקין (קואורדינטות)
   - סוג בעיה חובה
   - תיאור חובה
3. **בדיקת בקשות פתוחות:** וודא שאין למשתמש בקשה פתוחה אחרת (סטטוס pending או assigned)
4. **וולידציה של תשלום:** אם הוצע סכום, בודקת שהוא חיובי (בעגורות - 1 ש"ח = 100 עגורות)
5. **יצירה ושמירה:** יוצרת בקשה חדשה עם סטטוס `pending`
6. **Populate:** ממלאת את פרטי המשתמש
7. **שידור בזמן אמת:** משדרת את הבקשה החדשה לכל המשתמשים המחוברים דרך Socket.IO

**הערות חשובות:**
- סכום התשלום נשמר בעגורות (100 עגורות = 1 ש"ח)
- המערכת לא מאפשרת למשתמש ליצור יותר מבקשה פתוחה אחת בו זמנית

---

### 2.2 `getActiveRequests` - קבלת בקשות פעילות למפה

**שם הפונקציה:** `exports.getActiveRequests`

**הסבר:**
מחזירה את כל הבקשות הפעילות (pending, assigned, in_progress) להצגה במפה בזמן אמת.

**תהליך לוגי:**
1. **חיפוש:** מחפשת בקשות עם סטטוס פעיל
2. **Populate:** ממלאת פרטי משתמש ועוזר
3. **חישוב עמלה:** מוסיפה חישוב עמלת הפלטפורמה לכל בקשה
4. **מיון:** ממיינת לפי תאריך יצירה
5. **הגבלה:** עד 200 בקשות

**הערות חשובות:**
- מוסיפה אוטומטית את פרטי העמלה (10%) לכל תשלום
- העוזר מקבל את הסכום המעוגל, הפלטפורמה את היתרה

---

### 2.3 `assignRequest` - הקצאת עוזר לבקשה

**שם הפונקציה:** `exports.assignRequest`

**הסבר:**
מאפשרת למתנדב להקצות את עצמו לבקשת עזרה כדי לבוא לעזור.

**תהליך לוגי:**
1. **חיפוש בקשה:** מוצאת את הבקשה לפי ID
2. **בדיקת סטטוס:** וודא שהבקשה במצב `pending` (לא הוקצתה עדיין)
3. **בדיקה שלא בעלים:** עוזר לא יכול לעזור לעצמו
4. **חישוב ETA:** מחשבת זמן הגעה משוער ומרחק מהעוזר לנקודת התקלה
5. **עדכון:** משנה סטטוס ל-`assigned`, מוסיפה את העוזר ונתוני ETA
6. **שידור:** משדרת עדכון לכולם דרך Socket.IO

**הערות חשובות:**
- משתמש את שירות OSRM לחישוב מסלול מדויק (או נופל לחישוב Haversine)
- יוצרת אוטומטית שיחת צ'אט בין המבקש והעוזר

---

### 2.4 פונקציות נוספות ב-Requests Controller

#### `getMyRequests` - הבקשות שלי
מחזירה את כל הבקשות שהמשתמש יצר.

#### `getMyHelpRequests` - הבקשות שאני עוזר בהן
מחזירה בקשות שהמשתמש הוקצה אליהן כעוזר.

#### `updateRequestStatus` - עדכון סטטוס בקשה
מאפשרת לעדכן את הסטטוס של בקשה (למשל ל-`in_progress` או `completed`).

#### `cancelRequest` - ביטול בקשה
מאפשרת למבקש לבטל בקשה ומשדרת זאת לכולם.

#### `sanitizeRequest`
פונקציית עזר שמנקה אובייקט בקשה לשידור (מסירה מידע רגיש).

---

## 3. בקרת תשלומים (Payment Controller)

**מיקום:** `server/api/controllers/paymentController.js`

### 3.1 `createOrder` - יצירת הזמנת PayPal

**שם הפונקציה:** `exports.createOrder`

**הסבר:**
יוצרת הזמנה ב-PayPal כדי שהמשתמש יוכל לשלם לעוזר דרך PayPal.

**תהליך לוגי:**
1. **קבלת נתונים:** מקבלת את ID הבקשה
2. **בדיקות אבטחה:**
   - וודא שהמשתמש הוא בעל הבקשה
   - וודא שיש עוזר מוקצה
   - וודא שהסכום תקין (לא אפס)
3. **המרה:** ממירה סכום מעגורות לש"ח
4. **יצירה ב-PayPal:** קוראת לשירות PayPal ליצירת הזמנה במטבע ILS
5. **חילוץ URL:** מחלצת את ה-approval URL מתשובת PayPal
6. **תגובה:** מחזירה את ה-orderId וה-URL לאישור

**הערות חשובות:**
- עובדת עם PayPal Sandbox או Live (לפי ENV)
- תומכת רק במטבע ILS (שקלים)
- לא מאפשרת יצירת תשלום עבור עזרה חינמית

---

### 3.2 `captureOrder` - לכידת תשלום PayPal

**שם הפונקציה:** `exports.captureOrder`

**הסבר:**
לוכדת את התשלום אחרי שהמשתמש אישר ב-PayPal ומבצעת את כל ההעברות הכספיות.

**תהליך לוגי:**
1. **קבלת נתונים:** orderId ו-requestId
2. **לכידה ב-PayPal:** קוראת ל-PayPal לאשר ולקלוט את התשלום
3. **אימות תשלום:**
   - בודקת שהסטטוס `COMPLETED`
   - וודא שהמטבע ILS
   - וודא שהסכום תואם
4. **חישוב עמלה:** מחשבת את חלק העוזר (90%) וחלק הפלטפורמה (10%)
5. **עדכון יתרות:**
   - מוסיפה סכום לעוזר ב-`balance`
   - מעדכנת `totalEarnings` של העוזר
6. **עדכון בקשה:** מסמנת את התשלום כ-`isPaid`
7. **תיעוד טרנזקציה:** יוצרת רשומת טרנזקציה במסד הנתונים
8. **שידור:** משדרת עדכון על תשלום שהושלם

**הערות חשובות:**
- העוזר מקבל סכום מעוגל ונקי (למשל 45.0 ש"ח)
- הפלטפורמה לוקחת את יתרת העמלה
- כל התהליך מתועד בטבלת Transactions

---

### 3.3 `confirmCompletionWithoutPayment` - אישור השלמה ללא תשלום

**שם הפונקציה:** `exports.confirmCompletionWithoutPayment`

**הסבר:**
מאפשרת למבקש לאשר שהעזרה הושלמה בהצלחה במקרים של עזרה חינמית (בלי תשלום).

**תהליך לוגי:**
1. **חיפוש בקשה**
2. **בדיקת הרשאות:** רק המבקש יכול לאשר
3. **בדיקה שאין תשלום או ששולם**
4. **עדכון סטטוס:** משנה ל-`completed`
5. **שידור עדכון**

---

## 4. בקרת צ'אט (Chat Controller)

**מיקום:** `server/api/controllers/chatController.js`

### 4.1 `getUserConversations` - קבלת כל השיחות של משתמש

**שם הפונקציה:** `exports.getUserConversations`

**הסבר:**
מחזירה את כל שיחות הצ'אט של המשתמש (גם כמבקש וגם כעוזר).

**תהליך לוגי:**
1. **חיפוש:** מחפשת שיחות שבהן המשתמש הוא `user` או `helper`
2. **סינון:** רק שיחות פעילות
3. **Populate:** ממלאת פרטי משתמשים ובקשה
4. **מיון:** לפי הודעה אחרונה

---

### 4.2 `getOrCreateConversation` - קבלה או יצירת שיחה לבקשה

**שם הפונקציה:** `exports.getOrCreateConversation`

**הסבר:**
מחזירה שיחת צ'אט קיימת לבקשה, או יוצרת חדשה אם לא קיימת.

**תהליך לוגי:**
1. **חיפוש בקשה:** מוצאת את הבקשה
2. **בדיקת הרשאות:** וודא שהמשתמש חלק מהבקשה
3. **חיפוש שיחה:** מחפשת שיחה קיימת
4. **יצירה:** אם לא קיימת, יוצרת שיחה חדשה
5. **החזרה:** מחזירה את השיחה

**הערות חשובות:**
- שיחה נוצרת אוטומטית כשעוזר מוקצה לבקשה
- משתמש לא יכול להיות העוזר של עצמו

---

### 4.3 `sendMessage` - שליחת הודעה

**שם הפונקציה:** `exports.sendMessage`

**הסבר:**
שולחת הודעה בשיחת צ'אט (בעיקר גיבוי ל-REST, Socket.IO מועדף).

**תהליך לוגי:**
1. **ולידציה:** בודקת שיש תוכן להודעה
2. **שימוש ב-Service:** קוראת ל-`chatService.appendMessage`
3. **Populate:** ממלאת נתונים
4. **תגובה:** מחזירה את השיחה המעודכנת

---

## 5. בקרת דירוגים (Rating Controller)

**מיקום:** `server/api/controllers/ratingController.js`

### 5.1 `createRating` - יצירת דירוג

**שם הפונקציה:** `exports.createRating`

**הסבר:**
מאפשרת למבקש לדרג את העוזר שעזר לו, לאחר סיום הבקשה.

**תהליך לוגי:**
1. **קבלת נתונים:** requestId, ציון (1-5), ביקורת טקסטואלית (אופציונלי)
2. **ולידציה:**
   - ציון חייב להיות מספר שלם בין 1-5
   - requestId חובה
3. **חיפוש בקשה:** מוצאת את הבקשה ובודקת:
   - הבקשה הושלמה (`completed`)
   - המדרג הוא בעל הבקשה
   - יש עוזר מוקצה
4. **בדיקת כפילות:** וודא שהבקשה טרם דורגה
5. **יצירת דירוג:** שומרת את הדירוג
6. **עדכון ממוצע:** מחשבת מחדש את ממוצע הדירוג של העוזר
7. **תגובה:** מחזירה את הדירוג ואת הממוצע המעודכן

**הערות חשובות:**
- רק בקשות שהושלמו ניתן לדרג
- כל בקשה ניתן לדרג פעם אחת בלבד
- הדירוגים אנונימיים (לא רואים מי דירג)

---

### 5.2 `updateHelperRating` - עדכון ממוצע דירוג

**שם הפונקציה:** `updateHelperRating`

**הסבר:**
פונקציית עזר שמחשבת מחדש את ממוצע הדירוג של עוזר.

**תהליך לוגי:**
1. **חיפוש כל הדירוגים:** מוצאת את כל הדירוגים של העוזר
2. **חישוב ממוצע:** מחשבת ממוצע (מעוגל ל-2 ספרות אחרי הנקודה)
3. **עדכון:** מעדכנת את `averageRating` ו-`ratingCount` במודל המשתמש

---

### 5.3 `getRatingsByHelper` - קבלת דירוגים של עוזר

**שם הפונקציה:** `exports.getRatingsByHelper`

**הסבר:**
מחזירה את כל הדירוגים שעוזר ספציפי קיבל, עם פגינציה.

**תהליך לוגי:**
1. **קבלת פרמטרים:** helperId, page, limit
2. **חיפוש:** מחפשת דירוגים של העוזר
3. **Populate:** ממלאת את פרטי הבקשה (לא את המדרג!)
4. **מיון:** לפי תאריך
5. **פגינציה:** מחלקת לעמודים
6. **תגובה:** מחזירה דירוגים + סטטיסטיקות

**הערות חשובות:**
- הדירוגים אנונימיים - לא מציגים מי דירג
- רק מציגים את סוג הבקשה ותאריך

---

## 6. בקרת מנהל מערכת (Admin Controller)

**מיקום:** `server/api/controllers/adminController.js`

### 6.1 `getOverview` - לוח בקרה סטטיסטי

**שם הפונקציה:** `exports.getOverview`

**הסבר:**
מחזירה נתונים סטטיסטיים מקיפים על המערכת ללוח הבקרה של המנהל.

**תהליך לוגי:**
1. **ספירות:**
   - סך משתמשים
   - משתמשים חסומים
   - בקשות פעילות
   - בקשות שהושלמו
   - דיווחים פתוחים
2. **נפח עסקאות:** סך כל הכסף שעבר במערכת
3. **גרף עמודות:** רישומי משתמשים ב-12 החודשים האחרונים
4. **גרף עוגה:** התפלגות סוגי הבעיות
5. **תגובה:** מחזירה את כל הנתונים מאורגנים

**הערות חשובות:**
- משתמשת ב-aggregation של MongoDB לחישובים יעילים
- מתאימה לתצוגת דשבורד אינטראקטיבית

---

### 6.2 `getUsers`, `getRequests`, `getTransactions`

פונקציות שמחזירות רשימות מלאות של ישויות במערכת עם פגינציה:
- **`getUsers`**: כל המשתמשים
- **`getRequests`**: כל הבקשות
- **`getTransactions`**: כל העסקאות הכספיות

כולן תומכות בפגינציה ומיון.

---

## 7. אימות וזיהוי (Authentication Middleware)

**מיקום:** `server/api/authMiddleware.js`

### 7.1 `authMiddleware` - Middleware לאימות משתמשים

**שם הפונקציה:** `authMiddleware`

**הסבר:**
Middleware שבודק את תקינות ה-JWT token ומוסיף את פרטי המשתמש ל-request.

**תהליך לוגי:**
1. **חילוץ טוקן:** מחלץ את הטוקן מה-header `Authorization`
2. **אימות:** מאמת את הטוקן עם `verifyToken`
3. **הוספה ל-request:** מוסיף `req.user` ו-`req.userId`
4. **בדיקת חסימה:** בודקת במסד נתונים אם המשתמש חסום
5. **המשך או שגיאה:** אם הכל תקין - `next()`, אחרת - שגיאת 401/403

**שגיאות אפשריות:**
- 401: אין טוקן / טוקן לא תקין / טוקן פג תוקף
- 403: משתמש חסום
- 404: משתמש לא נמצא

---

### 7.2 `adminOnly` - Middleware להרשאות מנהל

**שם הפונקציה:** `adminOnly`

**הסבר:**
Middleware שבודק שהמשתמש הוא מנהל מערכת.

**תהליך לוגי:**
1. **בדיקת אימות:** וודא ש-`req.userId` קיים
2. **חיפוש משתמש:** מוצא את המשתמש במסד הנתונים
3. **בדיקת role:** בודקת ש-`user.role === 'admin'`
4. **המשך או שגיאה:** 403 אם לא מנהל, `next()` אם כן

**הערות חשובות:**
- חייב לרוץ אחרי `authMiddleware`
- משמש להגנה על נתיבי מנהל

---

## 8. שירות צ'אט (Chat Service)

**מיקום:** `server/api/services/chatService.js`

### 8.1 `appendMessage` - הוספת הודעה לשיחה

**שם הפונקציה:** `appendMessage`

**הסבר:**
לוגיקה עסקית משותפת להוספת הודעות לשיחות, בשימוש גם על ידי HTTP controllers וגם Socket.IO handlers.

**תהליך לוגי:**
1. **חיפוש שיחה:** מוצאת את השיחה לפי ID
2. **בדיקת הרשאות:** וודא שהשולח הוא משתתף בשיחה
3. **יצירת הודעה:** יוצרת אובייקט הודעה עם timestamp
4. **תמיכה בהודעות מערכת:** אפשרות להוסיף הודעות מערכת (למשל "הטיפול הסתיים")
5. **שמירה:** מוסיפה להודעות ושומרת
6. **החזרה:** מחזירה את השיחה והודעה החדשה

**פרמטרים:**
- `conversationId`: ID השיחה
- `senderId`: ID השולח
- `content`: תוכן ההודעה
- `isSystemMessage`: האם זו הודעת מערכת (אופציונלי)
- `systemMessageType`: סוג הודעת מערכת (אופציונלי)

---

### 8.2 `markConversationRead` - סימון הודעות כנקראו

**שם הפונקציה:** `markConversationRead`

**הסבר:**
מסמנת את כל ההודעות שלא נקראו בשיחה כנקראו.

**תהליך לוגי:**
1. **חיפוש שיחה**
2. **בדיקת הרשאות**
3. **סימון:** עוברת על כל ההודעות ומסמנת `read: true` להודעות שהמשתמש לא שלח
4. **שמירה:** שומרת רק אם היו עדכונים
5. **החזרה:** מחזירה את השיחה המעודכנת

---

## 9. שירות PayPal

**מיקום:** `server/api/services/paypalService.js`

### 9.1 `getAccessToken` - קבלת טוקן גישה מ-PayPal

**שם הפונקציה:** `getAccessToken`

**הסבר:**
מתחברת ל-PayPal OAuth ומקבלת טוקן גישה לביצוע פעולות.

**תהליך לוגי:**
1. **חילוץ אישורים:** מקבלת CLIENT_ID ו-CLIENT_SECRET מה-ENV
2. **יצירת Basic Auth:** מקודדת ב-Base64
3. **קריאה ל-PayPal:** שולחת בקשת POST ל-OAuth endpoint
4. **החזרת טוקן:** מחזירה את ה-access_token

**הערות חשובות:**
- עובדת עם Sandbox או Live לפי ENV
- הטוקן תקף לזמן מוגבל (בדרך כלל שעה)

---

### 9.2 `createPayPalOrder` - יצירת הזמנה ב-PayPal

**שם הפונקציה:** `createPayPalOrder`

**הסבר:**
יוצרת הזמנה חדשה ב-PayPal במטבע ILS.

**תהליך לוגי:**
1. **ולידציה:** בודקת שהסכום תקין ולא אפס
2. **המרה:** ממירה מעגורות לש"ח (string מעוצב)
3. **קבלת טוקן:** קוראת ל-`getAccessToken`
4. **יצירת אובייקט הזמנה:**
   - Intent: CAPTURE
   - Currency: ILS
   - Description
   - Return/Cancel URLs
5. **שליחה ל-PayPal:** POST ל-`/v2/checkout/orders`
6. **החזרה:** מחזירה את ה-order object עם links

**הערות חשובות:**
- מגדירה `locale: 'he-IL'` לממשק עברי
- `shipping_preference: 'NO_SHIPPING'` - אין משלוח פיזי

---

### 9.3 `capturePayPalOrder` - לכידת תשלום

**שם הפונקציה:** `capturePayPalOrder`

**הסבר:**
לוכדת את התשלום אחרי אישור המשתמש ב-PayPal.

**תהליך לוגי:**
1. **קבלת טוקן**
2. **לכידה:** POST ל-`/v2/checkout/orders/{orderId}/capture`
3. **החזרה:** מחזירה את המידע המלא על התשלום שנלכד

---

## 10. תקשורת בזמן אמת (Chat Sockets)

**מיקום:** `server/api/sockets/chatSockets.js`

### 10.1 `initializeChatSockets` - אתחול Socket.IO

**שם הפונקציה:** `initializeChatSockets`

**הסבר:**
מאתחלת את כל המטפלים (handlers) של Socket.IO לתקשורת בזמן אמת.

**תהליך לוגי:**
1. **Middleware אימות:** מוסיפה `authenticateSocket` לכל החיבורים
2. **טיפול בחיבור:** כשמשתמש מתחבר:
   - מצרפת אותו לחדר אישי (`user:${userId}`)
   - מאזינה לאירועים שונים

**אירועים נתמכים:**

#### `join_conversation` - הצטרפות לשיחה
- מצרפת את המשתמש לחדר שיחה ספציפי
- בודקת הרשאות

#### `leave_conversation` - עזיבת שיחה
- מוציאה מחדר השיחה

#### `send_message` - שליחת הודעה
- מקבלת הודעה
- קוראת ל-`chatService.appendMessage`
- משדרת לכל המשתתפים בשיחה

#### `mark_as_read` - סימון כנקרא
- מסמנת הודעות כנקראו
- מודיעה למשתמש השני

#### `typing` - אינדיקטור כתיבה
- משדרת למשתתפים אחרים ש"משתמש מקליד..."

---

### 10.2 `authenticateSocket` - אימות Socket.IO

**שם הפונקציה:** `authenticateSocket`

**הסבר:**
Middleware שמאמת את המשתמש לפני חיבור Socket.IO.

**תהליך לוגי:**
1. **חילוץ טוקן:** מ-`handshake.auth.token` או headers
2. **אימות:** קוראת ל-`verifyToken`
3. **הוספה:** מוסיפה `socket.userId`
4. **שגיאה או המשך:** `next(error)` או `next()`

---

## 11. פונקציות עזר (Utilities)

### 11.1 ETA Utils

**מיקום:** `server/api/utils/etaUtils.js`

#### `calculateETAWithDistance`

**הסבר:**
מחשבת זמן הגעה משוער ומרחק בין שתי נקודות.

**תהליך לוגי:**
1. **שימוש ב-OSRM:** קוראת ל-OSRM routing service (OpenStreetMap)
2. **קבלת נתונים:** זמן נסיעה (בשניות) ומרחק (במטרים)
3. **Fallback:** אם OSRM נכשל, משתמשת בנוסחת Haversine
   - מחשבת מרחק "קו אווירי"
   - מניחה מהירות ממוצעת של 30 קמ"ש בעיר
4. **החזרה:** `{ etaSeconds, distanceMeters }`

**הערות חשובות:**
- OSRM מספקת מסלול מדויק על כבישים
- Haversine היא הערכה גסה יותר

---

### 11.2 Commission Utils

**מיקום:** `server/api/utils/commissionUtils.js`

#### `calculateCommission`

**הסבר:**
מחשבת את חלוקת התשלום בין העוזר והפלטפורמה.

**לוגיקה:**
1. **חישוב ראשוני:** העוזר מקבל 90% (ברירת מחדל)
2. **עיגול:** מעגלת את חלק העוזר לספרה אחת אחרי הנקודה
3. **יתרה:** הפלטפורמה מקבלת את מה שנשאר

**דוגמה:**
- סכום כולל: 50 ש"ח
- 90% = 45 ש"ח
- עיגול: 45.0 ש"ח (העוזר)
- עמלה: 5.0 ש"ח (הפלטפורמה)

**הערות חשובות:**
- העוזר תמיד מקבל סכום "נקי" ומעוגל
- זה מונע בעיות של "סנטים נוספים"

---

### 11.3 Cleanup Service

**מיקום:** `server/api/services/cleanupService.js`

#### `cleanupExpiredRequests`

**הסבר:**
פונקציית רקע שמנקה בקשות ישנות שלא הושלמו.

**תהליך לוגי:**
1. **חישוב cutoff:** בקשות שנוצרו לפני 5 שעות
2. **חיפוש:** מוצאת בקשות פעילות ישנות
3. **מחיקה:** מוחקת אותן אחת אחת
4. **שידור:** משדרת `requestDeleted` לכולם

#### `initCleanupJob`

מאתחלת עבודת רקע שרצה כל שעה ומנקה בקשות פגות תוקף.

---

## סיכום ארכיטקטורה

### זרימת בקשת עזרה טיפוסית:

1. **יצירה** (`createRequest`):
   - משתמש יוצר בקשה עם מיקום ובעיה
   - הבקשה נשמרת במסד נתונים עם סטטוס `pending`
   - משודרת לכל המשתמשים במפה

2. **הקצאה** (`assignRequest`):
   - מתנדב רואה את הבקשה במפה ולוחץ "אני בא לעזור"
   - מחשבים ETA ומרחק
   - משנים סטטוס ל-`assigned`
   - יוצרים שיחת צ'אט אוטומטית

3. **תקשורת**:
   - מבקש ועוזר מתקשרים דרך צ'אט בזמן אמת (Socket.IO)
   - עוזר מעדכן מיקום בדרך
   - מבקש רואה ETA מעודכן

4. **התקדמות** (`updateRequestStatus`):
   - עוזר מגיע ומשנה סטטוס ל-`in_progress`
   - מתקנים את התקלה

5. **סיום והשלמה**:
   - עוזר מסיים ומשנה ל-`completed`
   - אם יש תשלום: מבקש משלם דרך PayPal
   - אם חינם: מבקש מאשר השלמה

6. **תשלום** (אם רלוונטי):
   - `createOrder`: יוצרים הזמנה ב-PayPal
   - משתמש מאשר ב-PayPal
   - `captureOrder`: לוכדים תשלום, מעדכנים יתרות
   - יוצרים רשומת טרנזקציה

7. **דירוג** (`createRating`):
   - מבקש מדרג את העוזר
   - עוזר מקבל עדכון בממוצע הדירוג שלו

### אבטחה:

- **JWT Tokens:** כל בקשה מאומתת
- **Authorization:** בדיקת הרשאות (למשל: רק בעל הבקשה יכול לבטל)
- **Socket.IO Auth:** גם חיבורי WebSocket מאומתים
- **Validation:** כל קלט נבדק לפני שמירה
- **Sanitization:** הסרת מידע רגיש לפני שליחה ללקוח

### ביצועים:

- **Indexes:** על שדות חיפוש חשובים (status, location, user)
- **Pagination:** תמיכה בפגינציה בכל מקום
- **Populate:** טעינה מבוקרת של יחסים
- **Background Jobs:** ניקוי אוטומטי של בקשות ישנות

---

**סוף המדריך**

קובץ זה מתעד את הפונקציות המרכזיות בשרת. לשאלות נוספות או הבהרות, ניתן לעיין בקוד המקור של כל פונקציה.
