# ILS Payment Flow - Visual Diagram

## ğŸ”„ Complete Payment Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        1. CREATE REQUEST                             â”‚
â”‚                                                                      â”‚
â”‚  User enters: "I need help, willing to pay 50 ILS"                 â”‚
â”‚                                                                      â”‚
â”‚  Frontend:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ const agorot = ilsToAgorot(50)     â”‚                            â”‚
â”‚  â”‚ // agorot = 5000                   â”‚                            â”‚
â”‚  â”‚                                    â”‚                            â”‚
â”‚  â”‚ POST /api/requests                 â”‚                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   problemType: "flat_tire",        â”‚                            â”‚
â”‚  â”‚   offeredAmount: 5000,  â† Agorot! â”‚                            â”‚
â”‚  â”‚   currency: "ILS"                  â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â†“                                                â”‚
â”‚  Database:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   _id: "abc123",                   â”‚                            â”‚
â”‚  â”‚   payment: {                       â”‚                            â”‚
â”‚  â”‚     offeredAmount: 5000,  â† Agorotâ”‚                            â”‚
â”‚  â”‚     currency: "ILS",               â”‚                            â”‚
â”‚  â”‚     isPaid: false                  â”‚                            â”‚
â”‚  â”‚   }                                â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     2. INITIATE PAYMENT                              â”‚
â”‚                                                                      â”‚
â”‚  User clicks: "Pay with PayPal"                                     â”‚
â”‚                                                                      â”‚
â”‚  Frontend:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ POST /api/payments/create-order    â”‚                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   requestId: "abc123"              â”‚                            â”‚
â”‚  â”‚   // NO amount sent!               â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â†“                                                â”‚
â”‚  Backend:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ 1. Find request by ID              â”‚                            â”‚
â”‚  â”‚ 2. Get amount: 5000 agorot         â”‚                            â”‚
â”‚  â”‚ 3. Validate:                       â”‚                            â”‚
â”‚  â”‚    âœ“ Amount > 0                    â”‚                            â”‚
â”‚  â”‚    âœ“ Is integer                    â”‚                            â”‚
â”‚  â”‚ 4. Convert:                        â”‚                            â”‚
â”‚  â”‚    agorotToIlsString(5000)         â”‚                            â”‚
â”‚  â”‚    = "50.00"                       â”‚                            â”‚
â”‚  â”‚ 5. Create PayPal order:            â”‚                            â”‚
â”‚  â”‚    {                               â”‚                            â”‚
â”‚  â”‚      currency_code: "ILS", â† FIXEDâ”‚                            â”‚
â”‚  â”‚      value: "50.00"                â”‚                            â”‚
â”‚  â”‚    }                               â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â†“                                                â”‚
â”‚  Log output:                                                         â”‚
â”‚  ğŸ”µ Creating PayPal order:                                          â”‚
â”‚     amount_agorot: 5000                                             â”‚
â”‚     amount_ils: "50.00"                                             â”‚
â”‚     currency: "ILS"                                                 â”‚
â”‚                                                                      â”‚
â”‚  âœ… PayPal order created:                                           â”‚
â”‚     order_id: "xyz789"                                              â”‚
â”‚     currency: "ILS"                                                 â”‚
â”‚     value: "50.00"                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    3. USER APPROVES ON PAYPAL                        â”‚
â”‚                                                                      â”‚
â”‚  PayPal Checkout Page:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚                                    â”‚                            â”‚
â”‚  â”‚     Pay 50.00 ILS â† Shows ILS!    â”‚                            â”‚
â”‚  â”‚                                    â”‚                            â”‚
â”‚  â”‚  [Approve] [Cancel]                â”‚                            â”‚
â”‚  â”‚                                    â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â†“                                                â”‚
â”‚  User clicks "Approve"                                              â”‚
â”‚                     â†“                                                â”‚
â”‚  Redirects to:                                                       â”‚
â”‚  /paypal/success?token=xyz789&requestId=abc123                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      4. CAPTURE PAYMENT                              â”‚
â”‚                                                                      â”‚
â”‚  Frontend (PayPalSuccess):                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ POST /api/payments/capture-order   â”‚                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   orderId: "xyz789",               â”‚                            â”‚
â”‚  â”‚   requestId: "abc123"              â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â†“                                                â”‚
â”‚  Backend:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ 1. Call PayPal capture API         â”‚                            â”‚
â”‚  â”‚ 2. Validate response:              â”‚                            â”‚
â”‚  â”‚    âœ“ status === "COMPLETED"        â”‚                            â”‚
â”‚  â”‚    âœ“ currency === "ILS" â† CHECK!   â”‚                            â”‚
â”‚  â”‚ 3. Extract captured amount:        â”‚                            â”‚
â”‚  â”‚    "50.00" ILS                     â”‚                            â”‚
â”‚  â”‚ 4. Convert to agorot:              â”‚                            â”‚
â”‚  â”‚    ilsToAgorot(50) = 5000          â”‚                            â”‚
â”‚  â”‚ 5. Verify amount matches:          â”‚                            â”‚
â”‚  â”‚    5000 === 5000 âœ“                 â”‚                            â”‚
â”‚  â”‚ 6. Calculate commission:           â”‚                            â”‚
â”‚  â”‚    Total:      5000 agorot (50 ILS)â”‚                            â”‚
â”‚  â”‚    Commission:  500 agorot (5 ILS) â”‚                            â”‚
â”‚  â”‚    Helper:     4500 agorot (45 ILS)â”‚                            â”‚
â”‚  â”‚ 7. Update database                 â”‚                            â”‚
â”‚  â”‚ 8. Credit helper wallet            â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â†“                                                â”‚
â”‚  Log output:                                                         â”‚
â”‚  ğŸ”µ Capturing PayPal order: xyz789                                  â”‚
â”‚                                                                      â”‚
â”‚  âœ… PayPal order captured:                                          â”‚
â”‚     currency: "ILS"                                                 â”‚
â”‚     value: "50.00"                                                  â”‚
â”‚                                                                      â”‚
â”‚  ğŸ’° Payment breakdown:                                              â”‚
â”‚     total_agorot: 5000                                              â”‚
â”‚     total_ils: 50                                                   â”‚
â”‚     commission_agorot: 500                                          â”‚
â”‚     commission_ils: 5                                               â”‚
â”‚     helper_agorot: 4500                                             â”‚
â”‚     helper_ils: 45                                                  â”‚
â”‚                                                                      â”‚
â”‚  âœ… Helper credited:                                                â”‚
â”‚     amount_ils: 45                                                  â”‚
â”‚     new_balance: 145                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       5. FINAL STATE                                 â”‚
â”‚                                                                      â”‚
â”‚  Database (Request):                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   _id: "abc123",                   â”‚                            â”‚
â”‚  â”‚   payment: {                       â”‚                            â”‚
â”‚  â”‚     offeredAmount: 5000,           â”‚                            â”‚
â”‚  â”‚     helperAmount: 4500,            â”‚                            â”‚
â”‚  â”‚     commissionAmount: 500,         â”‚                            â”‚
â”‚  â”‚     currency: "ILS",               â”‚                            â”‚
â”‚  â”‚     isPaid: true,                  â”‚                            â”‚
â”‚  â”‚     paymentMethod: "paypal"        â”‚                            â”‚
â”‚  â”‚   }                                â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                      â”‚
â”‚  Database (Helper User):                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   balance: 145,  â† +45 ILS         â”‚                            â”‚
â”‚  â”‚   totalEarnings: 245               â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                      â”‚
â”‚  Database (Transaction):                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ {                                  â”‚                            â”‚
â”‚  â”‚   type: "earning",                 â”‚                            â”‚
â”‚  â”‚   amount: 45,                      â”‚                            â”‚
â”‚  â”‚   currency: "ILS",                 â”‚                            â”‚
â”‚  â”‚   commission: {                    â”‚                            â”‚
â”‚  â”‚     amount: 5,                     â”‚                            â”‚
â”‚  â”‚     rate: 10                       â”‚                            â”‚
â”‚  â”‚   }                                â”‚                            â”‚
â”‚  â”‚ }                                  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ Key Points

### 1. Storage Layer (Database)
```
Everything in AGOROT (integer):
50 ILS = 5,000 agorot
```

### 2. API Layer (PayPal)
```
Convert to ILS string:
5,000 agorot â†’ "50.00" ILS
+ currency_code: "ILS"
```

### 3. Display Layer (Frontend)
```
Convert for display:
5,000 agorot â†’ 50â‚ª
```

## ğŸ›¡ï¸ Security Checkpoints

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Create Order  â”‚ âœ“ Backend validates amount is in agorot
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ âœ“ Backend validates amount > 0
â”‚ 2. PayPal API    â”‚ âœ“ Force currency_code: "ILS"
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ âœ“ Format value as "XX.XX"
â”‚ 3. Capture       â”‚ âœ“ Validate currency === "ILS"
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ âœ“ Verify amount matches
â”‚ 4. Database      â”‚ âœ“ Store in agorot
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ âœ“ Calculate commission correctly
```

## ğŸš« What Can't Go Wrong

### âŒ Frontend can't send wrong amount
```javascript
// Frontend doesn't send amount at all!
body: JSON.stringify({
    requestId  // Only this
})
```

### âŒ PayPal can't charge in USD
```javascript
// Hardcoded in paypalService.js
amount: {
    currency_code: 'ILS'  // Not configurable
}
```

### âŒ Can't have floating-point errors
```javascript
// All calculations in integer agorot
const total = 5000;  // Not 50.00
const commission = Math.round(total * 0.1);  // = 500
const helper = total - commission;  // = 4500
```

## ğŸ“Š Data Flow Summary

```
User Input (ILS) â†’ Frontend Converts â†’ Database (Agorot) â†’ PayPal (ILS) â†’ Backend Validates (Agorot) â†’ Database (Agorot) â†’ Display (ILS)
     50          â†’      5000         â†’      5000         â†’    "50.00"    â†’        5000            â†’      5000        â†’     50â‚ª
```

## ğŸ¯ Testing Checklist

- [ ] Create request with 50 ILS â†’ Database shows 5000 agorot
- [ ] Create PayPal order â†’ Logs show `currency: "ILS"`
- [ ] PayPal checkout â†’ Shows "50.00 ILS" (not USD)
- [ ] Capture payment â†’ Logs show `currency: "ILS"`
- [ ] Helper credited â†’ Wallet shows +45 ILS
- [ ] Transaction record â†’ Shows 45 ILS earning, 5 ILS commission
